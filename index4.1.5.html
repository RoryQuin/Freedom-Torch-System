<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NSC-SEA STRATEGIC TERMINAL 1975</title>
    <style>
        :root { --glow: #33FF33; --bg: #000a00; }
        body { background: #000; color: var(--glow); font-family: 'Courier New', monospace; margin: 0; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        
        /* CRT 磷光屏与扫描线动态效果 */
        #crt-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.15) 50%),
                        linear-gradient(90deg, rgba(255,0,0,0.05), rgba(0,255,0,0.01), rgba(0,0,255,0.05));
            background-size: 100% 3px, 3px 100%;
            pointer-events: none; z-index: 100; opacity: 0.8;
        }

        /* 扫描线上下滚动动画 */
        @keyframes scanline { 0% { top: -100%; } 100% { top: 100%; } }
        #scan-bar { 
            position: fixed; top: 0; left: 0; width: 100%; height: 50px; 
            background: linear-gradient(0deg, transparent, rgba(51, 255, 51, 0.1), transparent);
            animation: scanline 10s linear infinite; pointer-events: none; z-index: 101; 
        }

        #header { position: absolute; top: 20px; left: 20px; z-index: 10; text-shadow: 0 0 10px var(--glow); pointer-events: none; }
        #header * { pointer-events: auto; }

        #sidebar {
            position: absolute; right: 20px; top: 20px; width: 320px; bottom: 20px;
            border: 2px solid var(--glow); background: rgba(0, 15, 0, 0.96);
            padding: 20px; z-index: 10; overflow-y: auto;
            box-shadow: 0 0 25px rgba(51, 255, 51, 0.3);
            transition: transform 0.3s ease, opacity 0.3s ease;
            -webkit-overflow-scrolling: touch;
        }

        #sidebar.collapsed {
            transform: translateX(100%);
            opacity: 0;
        }

        #toggle-sidebar {
            position: absolute; right: 20px; top: 20px;
            width: 40px; height: 40px;
            background: rgba(0, 15, 0, 0.96);
            border: 2px solid var(--glow);
            z-index: 11;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--glow);
            transition: right 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        #toggle-sidebar:hover, #toggle-sidebar:active {
            background: rgba(0, 40, 0, 0.96);
            box-shadow: 0 0 15px rgba(51, 255, 51, 0.5);
        }

        #toggle-sidebar.show-toggle {
            right: 360px;
        }

        /* 移动端适配 */
        @media (max-width: 768px) {
            #header {
                top: 10px; left: 10px;
                font-size: 14px;
            }
            #header > div:first-child {
                font-size: 16px;
                letter-spacing: 1px;
            }
            #coords {
                font-size: 10px;
            }

            #sidebar {
                width: 85%;
                right: 10px; top: 60px; bottom: 10px;
                padding: 15px;
                font-size: 12px;
            }

            #toggle-sidebar {
                right: 10px; top: 10px;
                width: 35px; height: 35px;
                font-size: 20px;
            }

            #toggle-sidebar.show-toggle {
                right: calc(85% + 15px);
            }

            .dossier-label { font-size: 0.75em; }
            .dossier-value { font-size: 1em; }
            #sidebar > div:first-child {
                font-size: 16px;
                padding: 4px;
            }

            #color-palette {
                grid-template-columns: repeat(6, 1fr);
                gap: 2px;
            }

            #color-palette > div {
                height: 30px;
            }

            button {
                padding: 8px !important;
                font-size: 11px !important;
            }

            select {
                padding: 4px !important;
                font-size: 11px !important;
            }

            #log {
                font-size: 10px;
            }
        }

        @media (max-width: 480px) {
            #sidebar {
                width: 90%;
                right: 5px; top: 55px; bottom: 5px;
                padding: 10px;
            }

            #toggle-sidebar.show-toggle {
                right: calc(90% + 10px);
            }

            .dossier-label { font-size: 0.7em; }
            .dossier-value { font-size: 0.9em; }

            button {
                padding: 6px !important;
                font-size: 10px !important;
            }
        }

        .dossier-label { color: #88ff88; font-size: 0.85em; text-transform: uppercase; display: block; margin-top: 15px; border-left: 3px solid #33FF33; padding-left: 8px; }
        .dossier-value { font-size: 1.2em; margin-bottom: 8px; display: block; border-bottom: 1px solid #33FF33; padding: 5px 0; color: #fff; text-shadow: 0 0 5px var(--glow); }
        
        canvas { cursor: crosshair; }
        hr { border: 0; border-top: 2px dashed var(--glow); margin: 20px 0; }
        #log { font-size: 11px; color: #33FF33; line-height: 1.6; opacity: 0.9; }
    </style>
</head>
<body>

<div id="scan-bar"></div>
<div id="crt-overlay"></div>
<div id="header">
    <div style="font-size: 24px; font-weight: bold; letter-spacing: 3px;">[SECURE STRATEGIC RELAY // SEA-V4.2]</div>
    <div id="coords" style="font-size: 13px; margin-top: 5px;">GRID_REF: [WAITING FOR INPUT...]</div>
</div>

<button id="toggle-sidebar" onclick="toggleSidebar()">◀</button>

<div id="sidebar">
    <div style="text-align:center; font-size: 18px; font-weight: bold; background: var(--glow); color: black; padding: 5px;">位面地缘档案库</div>
    <div id="info-content">
        <p style="text-align: center; margin-top: 40px; opacity: 0.6;">请点击地图扇区<br>以解析该区域地缘情报</p>
    </div>
    <hr>
    <div style="margin-top: 15px;">
        <span class="dossier-label">标记点控制</span>
        <div style="margin-top: 10px;">
            <label style="color: #88ff88; font-size: 12px;">样式选择:</label>
            <select id="marker-style" style="background: #001100; color: #33FF33; border: 1px solid #33FF33; padding: 5px; width: 100%; margin-top: 5px;">
                <option value="0">十字准星 (战术目标)</option>
                <option value="1">警告三角 (高危区)</option>
                <option value="2">菱形哨所 (据点)</option>
                <option value="3">圆形集结点 (驻军)</option>
                <option value="4">扫描光圈 (异常现象)</option>
            </select>
        </div>
        <div style="margin-top: 10px;">
            <label style="color: #88ff88; font-size: 12px;">标记颜色:</label>
            <div id="color-palette" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 3px; margin-top: 5px;">
            </div>
        </div>
        <button id="add-marker-btn" onclick="startAddMarker()" style="width: 100%; margin-top: 10px; padding: 10px; background: #006400; color: #33FF33; border: 1px solid #33FF33; cursor: pointer; font-family: 'Courier New'; font-size: 14px;">[+] 添加标记点</button>
        <button onclick="clearMarkers()" style="width: 100%; margin-top: 5px; padding: 8px; background: #8B0000; color: #FF6666; border: 1px solid #FF0000; cursor: pointer; font-family: 'Courier New'; font-size: 12px;">[X] 清除所有标记</button>
    </div>
    <hr>
    <div id="log">> 链路状态：加密建立<br>> 坐标校准：已就绪</div>
</div>

<canvas id="map-canvas"></canvas>

<script src="mapData.js"></script>

<script>
    const canvas = document.getElementById('map-canvas');
    const ctx = canvas.getContext('2d');
    const infoBox = document.getElementById('info-content');

    let view = { x: 0, y: 0, zoom: 1500 };
    let selectedFeature = null;
    let markers = [];
    let selectedMarker = null;
    let isAddingMarker = false;
    let currentMarkerStyle = 0;
    let currentMarkerColor = '#FF0000';

    // 48种基本颜色
    const MARKER_COLORS = [
        '#FF0000', '#FF3333', '#FF6666', '#FF9999', '#FFCCCC', '#FFD700',
        '#FFA500', '#FF8C00', '#FF7F50', '#FF6347', '#FF4500', '#FF1493',
        '#FF69B4', '#FFB6C1', '#FFC0CB', '#FFDAB9', '#FFE4C4', '#FFE4B5',
        '#FF6B6B', '#FF8787', '#FFA3A3', '#FFBFBF', '#FFDCDC', '#FFFFFF',
        '#00FF00', '#00FF7F', '#00FA9A', '#00FFA7', '#00FFB7', '#00FFC8',
        '#00FF00', '#32CD32', '#7FFF00', '#7CFC00', '#ADFF2F', '#90EE90',
        '#00FF00', '#00FF7F', '#00FA9A', '#00FFA7', '#00FFB7', '#00FFC8',
        '#00FF00', '#32CD32', '#7FFF00', '#7CFC00', '#ADFF2F', '#90EE90'
    ];

    // 标记样式名称
    const MARKER_STYLES = ['十字准星', '警告三角', '菱形哨所', '圆形集结点', '扫描光圈'];

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const REGIME_NAMES = {
        'VNM_SOUTH': '南祈帝国 (实控)',
        'VNM_NORTH': '越南民主共和国',
        'KHM': '甘波银月制王国',
        'THA': '泰安迪亚王国',
        'MMR_STABLE': '掸罗王国',
        'MMR_REBEL': '掸罗民主共和国',
        'LAO': '葱森王国',
        'MYS': '银月太平洋监理政府',
        'SGP': '银月太平洋监理政府'
    };

    // 省份名称中英文映射表
    const PROVINCE_NAMES = {
        // 马来西亚
        'Sabah': '沙巴',
        'Sarawak': '砂拉越',
        'Labuan': '纳闽',
        'Kuala Lumpur': '吉隆坡',
        'Putrajaya': '布城',
        'Johor': '柔佛',
        'Kedah': '吉打',
        'Kelantan': '吉兰丹',
        'Melaka': '马六甲',
        'Negeri Sembilan': '森美兰',
        'Pahang': '彭亨',
        'Penang': '槟城',
        'Perak': '霹雳',
        'Perlis': '玻璃市',
        'Selangor': '雪兰莪',
        'Terengganu': '登嘉楼',

        // 越南
        'Kon Tum': '昆嵩',
        'Gia Lai': '嘉莱',
        'Đắk Lắk': '得乐',
        'Đắk Nông': '得农',
        'Lâm Đồng': '林同',
        'Bình Phước': '平福',
        'Bình Dương': '平阳',
        'Đồng Nai': '同奈',
        'Bà Rịa-Vũng Tàu': '巴地-头顿',
        'Tây Ninh': '西宁',
        'Hồ Chí Minh city': '西贡',
        'Long An': '隆安',
        'Tiền Giang': '前江',
        'Bến Tre': '槟椥',
        'Trà Vinh': '茶荣',
        'Vĩnh Long': '永隆',
        'Đồng Tháp': '同塔',
        'An Giang': '安江',
        'Cần Thơ': '芹苴',
        'Hậu Giang': '后江',
        'Kiên Giang': '建江',
        'Rạch Giá': '沥架',
        'Bạc Liêu': '薄辽',
        'Sóc Trăng': '朔庄',
        'Cà Mau': '金瓯',
        'Quảng Ninh': '广宁',
        'Hải Phòng': '海防',
        'Hải Dương': '海阳',
        'Quảng Ninh': '广宁',
        'Bắc Ninh': '北宁',
        'Bắc Giang': '北江',
        'Lạng Sơn': '谅山',
        'Cao Bằng': '高平',
        'Thái Nguyên': '太原',
        'Bắc Kạn': '北𣴓',
        'Tuyên Quang': '宣光',
        'Yên Bái': '安沛',
        'Điện Biên': '奠边',
        'Lai Châu': '莱州',
        'Sơn La': '山罗',
        'Hòa Bình': '和平',
        'Phú Thọ': '富寿',
        'Vĩnh Phúc': '永福',
        'Hà Nam': '河南',
        'Ninh Bình': '宁平',
        'Thanh Hóa': '清化',
        'Nghệ An': '义安',
        'Hà Tĩnh': '河静',
        'Quảng Bình': '广平',
        'Quảng Trị': '广治',
        'Thừa Thiên-Huế': '承天-顺化',
        'Đà Nẵng': '岘港',
        'Quảng Nam': '广南',
        'Quảng Ngãi': '广义',
        'Bình Định': '平定',
        'Phú Yên': '富安',
        'Khánh Hòa': '庆和',
        'Ninh Thuận': '宁顺',
        'Bình Thuận': '平顺',

        // 柬埔寨
        'Battambang': '马德望',
        'Banteay Meanchey': '班迭棉吉',
        'Pailin': '拜林',
        'Siem Reap': '暹粒',
        'Oddar Meanchey': '奥多棉吉',
        'Preah Vihear': '柏威夏',
        'Kampong Thom': '磅通',
        'Kampong Cham': '磅湛',
        'Kampong Chhnang': '磅清扬',
        'Kampong Speu': '磅士卑',
        'Kandal': '干丹',
        'Prey Veng': '波罗勉',
        'Svay Rieng': '柴桢',
        'Takeo': '茶胶',
        'Kampot': '贡布',
        'Kep': '白马',
        'Ratanakiri': '腊塔纳基里',
        'Mondulkiri': '蒙多基里',
        'Stung Treng': '上丁',
        'Kratie': '桔井',
        'Rôtânôkiri': '腊塔纳基里',
        'Môndól Kiri': '蒙多基里',
        'Krâchéh': '桔井',
        'Kâmpóng Cham': '磅湛',
        'Kâmpóng Chhnang': '磅清扬',
        'Kâmpóng Thum': '磅通',
        'Kâmpóng Spœ': '磅士卑',
        'Phnom Penh': '金边',
        'Kaôh Kong': '戈公',
        'Pouthisat': '菩萨',
        'Krong Pailin': '拜林',
        'Otdar Mean Chey': '奥多棉吉',
        'Preah Vihéar': '柏威夏',
        'Siemréab': '暹粒',
        'Bântéay Méanchey': '班迭棉吉',
        'Batdâmbâng': '马德望',
        'Kâmpôt': '贡布',

        // 泰国
        'Chiang Mai': '清迈',
        'Chiang Rai': '清莱',
        'Lampang': '南奔',
        'Lamphun': '南邦',
        'Mae Hong Son': '夜丰颂',
        'Nan': '难府',
        'Phayao': '帕夭',
        'Phrae': '帕',
        'Uttaradit': '程逸',
        'Sukhothai': '素可泰',
        'Phitsanulok': '彭世洛',
        'Kamphaeng Phet': '甘烹碧',
        'Phichit': '碧差汶',
        'Nakhon Sawan': '那空沙旺',
        'Uthai Thani': '乌泰他尼',
        'Chai Nat': '猜纳',
        'Sing Buri': '信武里',
        'Lop Buri': '华富里',
        'Ang Thong': '红统',
        'Ayutthaya': '大城',
        'Saraburi': '北标',
        'Nakhon Nayok': '那空那育',
        'Nakhon Ratchasima': '呵叻',
        'Buriram': '武里喃',
        'Chaiyaphum': '猜也贲',
        'Khon Kaen': '孔敬',
        'Nong Bua Lam Phu': '农磨兰普',
        'Nong Khai': '廊开',
        'Udon Thani': '乌隆他尼',
        'Loei': '黎府',
        'Nakhon Phanom': '那空帕农',
        'Sakon Nakhon': '色军',
        'Maha Sarakham': '马哈沙拉堪',
        'Roi Et': '黎逸',
        'Kalasin': '加拉信',
        'Mukdahan': '穆达汉',
        'Yasothon': '益梭通',
        'Amnat Charoen': '安纳乍伦',
        'Ubon Ratchathani': '乌汶',
        'Si Sa Ket': '四色菊',
        'Surin': '素辇',
        'Buri Ram': '武里喃',
        'Chanthaburi': '尖竹汶',
        'Trat': '达叻',
        'Chon Buri': '春武里',
        'Rayong': '罗勇',
        'Chachoengsao': '北柳',
        'Samut Prakan': '北榄',
        'Bangkok': '曼谷',
        'Phra Nakhon Si Ayutthaya': '大城',
        'Nonthaburi': '暖武里',
        'Pathum Thani': '巴吞他尼',
        'Samut Sakhon': '龙仔厝',
        'Samut Songkhram': '夜功',
        'Suphan Buri': '素攀武里',
        'Kanchanaburi': '北碧府',
        'Ratchaburi': '叻丕',
        'Phetchaburi': '碧差汶',
        'Prachuap Khiri Khan': '班武里',
        'Hua Hin': '华欣',
        'Phetchabun': '碧差汶',
        'Nakhon Pathom': '佛统',
        'Sa Kaeo': '沙缴',
        'Prachin Buri': '巴真',
        'Chachoengsao': '北柳',
        'Nakhon Ratchasima': '呵叻',
        'Satun': '沙敦',
        'Songkhla': '宋卡',
        'Yala': '也拉',
        'Narathiwat': '那拉提瓦',
        'Pattani': '北大年',
        'Yala': '也拉',
        'Narathiwat': '那拉提瓦',
        'Satun': '沙敦',
        'Songkhla': '宋卡',
        'Phangnga': '攀牙',
        'Phuket': '普吉',
        'Krabi': '甲米',
        'Trang': '董里',
        'Phatthalung': '博他仑',
        'Nakhon Si Thammarat': '洛坤',
        'Surat Thani': '素叻他尼',
        'Chumphon': '春蓬',
        'Ranong': '拉廊',
        'Prachuap Khiri Khan': '班武里',
        'Prachin Buri': '巴真',
        'Sa Kaeo': '沙缴',
        'Chai Nat': '猜纳',
        'Sing Buri': '信武里',
        'Lop Buri': '华富里',
        'Ang Thong': '红统',
        'Pathum Thani': '巴吞他尼',
        'Nonthaburi': '暖武里',
        'Samut Prakan': '北榄',
        'Samut Sakhon': '龙仔厝',
        'Samut Songkhram': '夜功',
        'Suphan Buri': '素攀武里',
        'Kanchanaburi': '北碧府',
        'Ratchaburi': '叻丕',
        'Phetchaburi': '碧差汶',
        'Prachuap Khiri Khan': '班武里',
        'Nakhon Pathom': '佛统',

        // 老挝
        'Phôngsali': '丰沙里',
        'Louang Namtha': '琅南塔',
        'Luang Namtha': '琅南塔',
        'Oudômxai': '乌多姆赛',
        'Bokeo': '博乔',
        'Louang Prabang': '琅勃拉邦',
        'Xaignabouli': '沙耶武里',
        'Xieng Khouang': '川圹',
        'Vientiane': '万象',
        'Bolikhamxai': '波里坎赛',
        'Khammouane': '甘蒙',
        'Savannakhet': '沙湾拿吉',
        'Saravan': '沙拉湾',
        'Sekong': '色贡',
        'Champasak': '占巴塞',
        'Attapeu': '阿速坡',
        'Phongsaly': '丰沙里',
        'Louangnamtha': '琅南塔',
        'Oudomxai': '乌多姆赛',
        'Luangprabang': '琅勃拉邦',
        'Xayabury': '沙耶武里',
        'Xiangkhouang': '川圹',
        'Vientiane': '万象',
        'Borikhamxay': '波里坎赛',
        'Khammouan': '甘蒙',
        'Savannakhét': '沙湾拿吉',
        'Saravan': '沙拉湾',
        'Xékong': '色贡',
        'Champasak': '占巴塞',
        'Attapu': '阿速坡',
        'Xaisômboun': '赛宋本',
        'Phongsaly': '丰沙里',
        'Louangnamtha': '琅南塔',
        'Oudomxai': '乌多姆赛',
        'Bokeo': '博乔',
        'Luangprabang': '琅勃拉邦',
        'Xayabouly': '沙耶武里',
        'Xiangkhouang': '川圹',
        'Vientiane': '万象',
        'Borikhamxay': '波里坎赛',
        'Khammouan': '甘蒙',
        'Savannakhét': '沙湾拿吉',
        'Saravan': '沙拉湾',
        'Sekong': '色贡',
        'Champasak': '占巴塞',
        'Attapeu': '阿速坡',

        // 缅甸
        'Kachin': '克钦',
        'Shan': '掸',
        'Kayah': '克耶',
        'Kayin': '克伦',
        'Mon': '孟',
        'Rakhine': '若开',
        'Yangon': '仰光',
        'Mandalay': '曼德勒',
        'Magway': '马圭',
        'Bago': '勃固',
        'Ayeyarwady': '伊洛瓦底',
        'Tanintharyi': '德林达依',
        'Naypyidaw': '内比都',
        'Pathein': '勃生',
        'Hpa-an': '帕安',
        'Taungoo': '东吁',
        'Pyay': '卑谬',
        'Mawlamyine': '毛淡棉',
        'Dawei': '土瓦',
        'Lashio': '腊戍',

        // 新加坡
        'Singapore': '新加坡'
    };

    function project(lon, lat) {
        const x = (lon - 105) * (Math.PI / 180);
        const y = Math.log(Math.tan((lat * Math.PI / 180) / 2 + Math.PI / 4));
        return { x: x * view.zoom, y: -y * view.zoom };
    }

    function unproject(px, py) {
        const x = (px - canvas.width / 2 - view.x) / view.zoom;
        const y = -(py - canvas.height / 2 - view.y) / view.zoom;
        const lon = x * (180 / Math.PI) + 105;
        const lat = (Math.atan(Math.exp(y)) - Math.PI / 4) * 2 * (180 / Math.PI);
        return { lon, lat };
    }

    function isPointInPoly(pt, poly) {
        let inside = false;
        for (let i = 0, j = poly.length - 1; i < poly.length; j = i++) {
            const xi = poly[i][0], yi = poly[i][1];
            const xj = poly[j][0], yj = poly[j][1];
            const intersect = ((yi > pt.lat) !== (yj > pt.lat)) && (pt.lon < (xj - xi) * (pt.lat - yi) / (yj - yi) + xi);
            if (intersect) inside = !inside;
        }
        return inside;
    }

    function getTacticalColor(props) {
        const name = props.name || "";
        const adm0 = props.adm0_a3 || "";
        const side = props.side || "";
        const southVNMCheck = ['Đông Nam Bộ', 'Hồ Chí Minh city', 'Ðong Tháp', 'Can Tho', 'Hau Giang', 'Quàng Nam', 'Đà Nẵng'];

        if (adm0 === 'VNM' && (side === 'SOUTH' || southVNMCheck.includes(name))) return "#FFFF00";
        if (adm0 === 'VNM' && side === 'NORTH') return "#ADD8E6";
        if (adm0 === 'LAO') return "#FFA500";
        if (adm0 === 'KHM') return "#FF4500";
        if (adm0 === 'THA') return "#E0E0E0";
        if (adm0 === 'MMR') {
            if (name === 'Shan' || name === 'Kachin' || side === 'LASHIO') return "#00008B";
            return "#006400";
        }
        if (adm0 === 'MYS' || adm0 === 'SGP') return "#A9A9A9";
        return "rgba(0, 40, 0, 0.4)";
    }

    function getStatusPattern(status) {
        const canvas = ctx.canvas;
        const patternCanvas = document.createElement('canvas');
        const pCtx = patternCanvas.getContext('2d');
        patternCanvas.width = 20;
        patternCanvas.height = 20;

        if (status === 'UNSTABLE') {
            // 稀疏的单向斜线纹理 - 蓝色加粗
            pCtx.strokeStyle = "rgba(0, 100, 255, 0.7)";
            pCtx.lineWidth = 2.5;
            for (let i = -20; i < 40; i += 20) {
                pCtx.beginPath();
                pCtx.moveTo(i, -20);
                pCtx.lineTo(i + 20, 20);
                pCtx.stroke();
            }
            // 添加半透明蓝色背景增强对比度
            pCtx.fillStyle = "rgba(0, 100, 255, 0.15)";
            pCtx.fillRect(0, 0, 20, 20);
        } else if (status === 'CAPTURED') {
            // 密集的交叉网格纹理
            pCtx.strokeStyle = "rgba(0, 191, 255, 0.6)";
            pCtx.lineWidth = 2.5;
            for (let i = 0; i <= 20; i += 5) {
                pCtx.beginPath();
                pCtx.moveTo(i, 0);
                pCtx.lineTo(i, 20);
                pCtx.stroke();
                pCtx.beginPath();
                pCtx.moveTo(0, i);
                pCtx.lineTo(20, i);
                pCtx.stroke();
            }
            // 添加高亮效果
            pCtx.fillStyle = "rgba(0, 191, 255, 0.3)";
            pCtx.fillRect(0, 0, 20, 20);
        }

        return ctx.createPattern(patternCanvas, 'repeat');
    }

    function getAllFeatures(data) {
        let features = [];
        if (!data) return features;
        if (data.type === "Feature") {
            features.push(data);
        } else if (data.features) {
            data.features.forEach(f => {
                features = features.concat(getAllFeatures(f));
            });
        }
        return features;
    }

    // 辅助函数：绘制带描边的文字，解决浅色背景下的辨识度问题
    function strokeText(text, x, y, mainColor, strokeColor = "black", lineWidth = 3) {
        ctx.lineJoin = "round";
        ctx.miterLimit = 2;
        ctx.strokeStyle = strokeColor;
        ctx.lineWidth = lineWidth;
        ctx.strokeText(text, x, y);
        ctx.fillStyle = mainColor;
        ctx.fillText(text, x, y);
    }

    function render() {
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        if (typeof MAP_DATA === 'undefined') return;

        const allFeatures = getAllFeatures(MAP_DATA);
        ctx.save();
        ctx.translate(canvas.width / 2 + view.x, canvas.height / 2 + view.y);

        allFeatures.forEach(f => {
            if (!f.geometry || !f.geometry.coordinates) return;
            ctx.beginPath();
            const polygons = f.geometry.type === "Polygon" ? [f.geometry.coordinates] : f.geometry.coordinates;
            polygons.forEach(polygon => {
                const ring = polygon[0];
                if (!ring) return;
                ring.forEach((pt, i) => {
                    const pos = project(pt[0], pt[1]);
                    if (i === 0) ctx.moveTo(pos.x, pos.y);
                    else ctx.lineTo(pos.x, pos.y);
                });
            });
            ctx.fillStyle = getTacticalColor(f.properties);
            ctx.fill();

            // 选中地块加深颜色
            if (selectedFeature === f) {
                ctx.fillStyle = "rgba(0, 0, 0, 0.4)";
                ctx.fill();
            }

            ctx.strokeStyle = "#4DFF4D";
            ctx.lineWidth = 1.8;
            ctx.stroke();

            ctx.strokeStyle = "rgba(51, 255, 51, 0.3)";
            ctx.lineWidth = 4;
            ctx.stroke();

            // 绘制状态纹样
            const status = f.properties.status || 'STABLE';
            if (status === 'UNSTABLE') {
                const pattern = getStatusPattern('UNSTABLE');
                ctx.fillStyle = pattern;
                ctx.fill();
            } else if (status === 'CAPTURED') {
                const pattern = getStatusPattern('CAPTURED');
                ctx.fillStyle = pattern;
                ctx.fill();
            }
        });

        // --- 核心城市与首都标记层 ---
        const cities = [
            { name: "西贡 (SAIGON)", lon: 106.66, lat: 10.76, type: "CAPITAL", align: "right" },
            { name: "河内 (HANOI)", lon: 105.83, lat: 21.02, type: "CAPITAL", align: "right" },
            { name: "曼谷 (BANGKOK)", lon: 100.50, lat: 13.75, type: "CAPITAL", align: "right" },
            { name: "金边 (PHNOM PENH)", lon: 104.91, lat: 11.55, type: "CAPITAL", align: "right" },
            { name: "万象 (VIENTIANE)", lon: 102.60, lat: 17.97, type: "CAPITAL", align: "right" },
            { name: "仰光 (RANGOON)", lon: 96.15, lat: 16.86, type: "CAPITAL", align: "right" },
            { name: "吉隆坡 (KUALA LUMPUR)", lon: 101.68, lat: 3.13, type: "CAPITAL", align: "right" },
            { name: "新加坡 (SINGAPORE)", lon: 103.85, lat: 1.29, type: "MAJOR", align: "right" },
            { name: "腊戎 (LASHIO)", lon: 97.75, lat: 22.96, type: "MAJOR", align: "right" },
            { name: "岘港 (DA NANG)", lon: 108.20, lat: 16.05, type: "MAJOR", align: "right" },
            { name: "清迈 (CHIANG MAI)", lon: 98.98, lat: 18.79, type: "MAJOR", align: "right" },
            { name: "顺化 (HUE)", lon: 107.59, lat: 16.46, type: "MAJOR", align: "right" },
            { name: "勃生 (PATHEIN)", lon: 94.73, lat: 16.78, type: "MAJOR", align: "left" },
            { name: "琅勃拉邦 (LUANG PRABANG)", lon: 102.13, lat: 19.88, type: "MAJOR", align: "right" },
            { name: "内比都 (NAYPYIDAW)", lon: 96.12, lat: 19.76, type: "MAJOR", align: "right" },
            { name: "马六甲 (MALACCA)", lon: 102.24, lat: 2.18, type: "MAJOR", align: "right" }
        ];

        cities.forEach(city => {
            const pos = project(city.lon, city.lat);
            
            if(city.type === "CAPITAL") {
                // 绘制首都外围黑色阴影描边（准星部分）
                ctx.strokeStyle = "rgba(0,0,0,1)";
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.moveTo(pos.x - 14, pos.y); ctx.lineTo(pos.x + 14, pos.y);
                ctx.moveTo(pos.x, pos.y - 14); ctx.lineTo(pos.x, pos.y + 14);
                ctx.stroke();

                // 绘制首都黄色主准星
                ctx.strokeStyle = "#FFFF00";
                ctx.lineWidth = 2.5;
                ctx.beginPath();
                ctx.moveTo(pos.x - 12, pos.y); ctx.lineTo(pos.x + 12, pos.y);
                ctx.moveTo(pos.x, pos.y - 12); ctx.lineTo(pos.x, pos.y + 12);
                ctx.stroke();

                ctx.fillStyle = "black";
                ctx.beginPath(); ctx.arc(pos.x, pos.y, 7, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = "#FFFF00";
                ctx.beginPath(); ctx.arc(pos.x, pos.y, 5, 0, Math.PI * 2); ctx.fill();
            } else {
                // 主要城市标记点
                ctx.fillStyle = "black";
                ctx.beginPath(); ctx.arc(pos.x, pos.y, 6, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = "#33FF33";
                ctx.beginPath(); ctx.arc(pos.x, pos.y, 4, 0, Math.PI * 2); ctx.fill();
            }

            // 绘制带有黑色轮廓的文字
            ctx.font = "bold 13px Courier New";
            const textX = city.align === "left" ? pos.x - 15 : pos.x + 18;
            ctx.textAlign = city.align === "left" ? "right" : "left";
            strokeText(city.name, textX, pos.y + 5, city.type === "CAPITAL" ? "#FFFF00" : "#33FF33");
        });

        // 绘制标记点
        markers.forEach((marker, index) => {
            const pos = project(marker.lon, marker.lat);
            const color = marker.color;
            const isSelected = selectedMarker === index;

            // 选中标记点的高亮光圈
            if (isSelected) {
                ctx.strokeStyle = "#FF0000";
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, 20, 0, Math.PI * 2);
                ctx.stroke();
            }

            // 绘制标记样式
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            ctx.lineWidth = 2;

            switch (marker.style) {
                case 0: // 十字准星 (战术目标)
                    ctx.beginPath();
                    ctx.moveTo(pos.x - 15, pos.y);
                    ctx.lineTo(pos.x + 15, pos.y);
                    ctx.moveTo(pos.x, pos.y - 15);
                    ctx.lineTo(pos.x, pos.y + 15);
                    ctx.stroke();
                    // 中心圆点
                    ctx.beginPath();
                    ctx.arc(pos.x, pos.y, 5, 0, Math.PI * 2);
                    ctx.fill();
                    break;

                case 1: // 警告三角 (高危区)
                    ctx.beginPath();
                    ctx.moveTo(pos.x, pos.y - 18);
                    ctx.lineTo(pos.x + 16, pos.y + 12);
                    ctx.lineTo(pos.x - 16, pos.y + 12);
                    ctx.closePath();
                    ctx.fillStyle = color;
                    ctx.fill();
                    ctx.strokeStyle = "#FFFFFF";
                    ctx.stroke();
                    // 感叹号
                    ctx.fillStyle = "#FFFFFF";
                    ctx.font = "bold 18px Arial";
                    ctx.textAlign = "center";
                    ctx.fillText("!", pos.x, pos.y + 8);
                    break;

                case 2: // 菱形哨所 (据点)
                    ctx.beginPath();
                    ctx.moveTo(pos.x, pos.y - 18);
                    ctx.lineTo(pos.x + 18, pos.y);
                    ctx.lineTo(pos.x, pos.y + 18);
                    ctx.lineTo(pos.x - 18, pos.y);
                    ctx.closePath();
                    ctx.fillStyle = color;
                    ctx.fill();
                    ctx.strokeStyle = "#FFFFFF";
                    ctx.stroke();
                    // 中心方形
                    ctx.fillStyle = "#FFFFFF";
                    ctx.fillRect(pos.x - 6, pos.y - 6, 12, 12);
                    break;

                case 3: // 圆形集结点 (驻军)
                    ctx.beginPath();
                    ctx.arc(pos.x, pos.y, 15, 0, Math.PI * 2);
                    ctx.fillStyle = color;
                    ctx.fill();
                    ctx.strokeStyle = "#FFFFFF";
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    // 中心点
                    ctx.beginPath();
                    ctx.arc(pos.x, pos.y, 5, 0, Math.PI * 2);
                    ctx.fillStyle = "#FFFFFF";
                    ctx.fill();
                    break;

                case 4: // 扫描光圈 (异常现象)
                    ctx.beginPath();
                    ctx.arc(pos.x, pos.y, 18, 0, Math.PI * 2);
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    // 内圈
                    ctx.beginPath();
                    ctx.arc(pos.x, pos.y, 12, 0, Math.PI * 2);
                    ctx.stroke();
                    // 中心十字
                    ctx.beginPath();
                    ctx.moveTo(pos.x - 8, pos.y);
                    ctx.lineTo(pos.x + 8, pos.y);
                    ctx.moveTo(pos.x, pos.y - 8);
                    ctx.lineTo(pos.x, pos.y + 8);
                    ctx.stroke();
                    break;
            }

            // 标记点文字
            if (marker.text) {
                ctx.font = "bold 12px Courier New";
                ctx.fillStyle = "white";
                ctx.textAlign = "center";
                strokeText(marker.text, pos.x, pos.y + 28, "white");
            }
        });

        ctx.restore();
    }

    canvas.addEventListener('click', (e) => {
        const pt = unproject(e.clientX, e.clientY);

        // 如果是添加标记模式
        if (isAddingMarker) {
            markers.push({
                lon: pt.lon,
                lat: pt.lat,
                style: currentMarkerStyle,
                color: currentMarkerColor,
                text: prompt("请输入标记文字:", "标记" + (markers.length + 1))
            });
            isAddingMarker = false;
            canvas.style.cursor = 'crosshair';
            render();
            return;
        }

        // 检查是否点击了标记点
        let clickedMarker = -1;
        markers.forEach((marker, index) => {
            const markerPos = project(marker.lon, marker.lat);
            const distance = Math.sqrt(Math.pow(e.clientX - (canvas.width / 2 + view.x + markerPos.x), 2) +
                                     Math.pow(e.clientY - (canvas.height / 2 + view.y + markerPos.y), 2));
            if (distance < 25) { // 增加触摸区域
                clickedMarker = index;
            }
        });

        if (clickedMarker !== -1) {
            // 选中标记点
            selectedMarker = clickedMarker;
            const marker = markers[clickedMarker];
            infoBox.innerHTML = `
                <span class="dossier-label">标记点</span><span class="dossier-value">${MARKER_STYLES[marker.style]}</span>
                <span class="dossier-label">标记文字</span><span class="dossier-value">${marker.text || '无'}</span>
                <span class="dossier-label">经纬度</span><span class="dossier-value">${marker.lon.toFixed(4)}, ${marker.lat.toFixed(4)}</span>
                <div style="margin-top:20px;">
                    <button onclick="deleteMarker(${clickedMarker})" style="width:100%;padding:10px;background:#8B0000;color:#FF0000;border:1px solid #FF0000;cursor:pointer;font-family:'Courier New';">[X] 删除此标记</button>
                </div>
            `;
            render();
            return;
        }

        // 正常点击地块
        const allFeatures = getAllFeatures(MAP_DATA);
        const found = allFeatures.find(f => {
            if (!f.geometry) return false;
            const polygons = f.geometry.type === "Polygon" ? [f.geometry.coordinates] : f.geometry.coordinates;
            return polygons.some(poly => isPointInPoly(pt, poly[0]));
        });

        if (found) {
            selectedFeature = found;
            selectedMarker = null; // 取消标记点选择
            let p = found.properties;
            let displayName = PROVINCE_NAMES[p.name] || p.name;
            let displaySide = "";
            const southVNMCheck = ['Đông Nam Bộ', 'Hồ Chí Minh city', 'Ðong Tháp', 'Can Tho', 'Hau Giang', 'Quàng Nam', 'Đà Nẵng'];

            if(p.adm0_a3 === 'VNM') {
                displaySide = (p.side === 'SOUTH' || southVNMCheck.includes(p.name)) ? REGIME_NAMES['VNM_SOUTH'] : REGIME_NAMES['VNM_NORTH'];
            } else if (p.adm0_a3 === 'MMR') {
                displaySide = (p.name === 'Shan' || p.name === 'Kachin' || p.side === 'LASHIO') ? REGIME_NAMES['MMR_REBEL'] : REGIME_NAMES['MMR_STABLE'];
            } else {
                displaySide = REGIME_NAMES[p.adm0_a3] || "中立/传统辖区";
            }

            const statusColor = p.status === 'UNSTABLE' ? '#ff0' : (p.status === 'CAPTURED' ? '#00BFFF' : '#33FF33');

            infoBox.innerHTML = `
                <span class="dossier-label">行政扇区</span><span class="dossier-value">${displayName}</span>
                <span class="dossier-label">地缘主权</span><span class="dossier-value" style="color:#FFFF00">${displaySide}</span>
                <span class="dossier-label">治安评级</span><span class="dossier-value" style="color:${statusColor}">${p.status || 'STABLE'}</span>
                <div style="margin-top:20px;">
                    <span class="dossier-label">变更状态</span>
                    <div style="display:flex;gap:5px;margin-top:8px;">
                        <button onclick="changeStatus('${displayName}', 'STABLE')" style="flex:1;padding:8px;background:#006400;color:#00FF00;border:1px solid #00FF00;cursor:pointer;font-family:'Courier New';">稳定</button>
                        <button onclick="changeStatus('${displayName}', 'UNSTABLE')" style="flex:1;padding:8px;background:#8B0000;color:#FF0000;border:1px solid #FF0000;cursor:pointer;font-family:'Courier New';">不稳定</button>
                        <button onclick="changeStatus('${displayName}', 'CAPTURED')" style="flex:1;padding:8px;background:#00008B;color:#00BFFF;border:1px solid #00BFFF;cursor:pointer;font-family:'Courier New';">控制权已夺取</button>
                    </div>
                </div>
            `;
            document.getElementById('log').innerHTML += `<br>> 情报解码: ${displayName}`;
            render();
        }
    });

    // 移动端触摸点击处理
    let lastTap = 0;
    let touchStartTime = 0;
    let touchStartPos = { x: 0, y: 0 };

    canvas.addEventListener('touchstart', (e) => {
        touchStartTime = Date.now();
        touchStartPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
    }, { passive: true });

    canvas.addEventListener('touchend', (e) => {
        const touchDuration = Date.now() - touchStartTime;
        const dx = e.changedTouches[0].clientX - touchStartPos.x;
        const dy = e.changedTouches[0].clientY - touchStartPos.y;
        const distance = Math.sqrt(dx * dx + dy * dy);

        // 判断是否为点击（短时间、短距离、单指）
        if (touchDuration < 300 && distance < 10 && e.touches.length === 0) {
            const currentTime = Date.now();
            const tapLength = currentTime - lastTap;

            // 双击检测
            if (tapLength < 300 && tapLength > 0) {
                // 双击缩放
                const pt = unproject(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
                view.zoom *= 1.5;
                render();
                e.preventDefault();
            } else {
                // 单击事件 - 复用点击逻辑
                const clickEvent = new Event('click');
                clickEvent.clientX = e.changedTouches[0].clientX;
                clickEvent.clientY = e.changedTouches[0].clientY;

                // 手动触发点击处理
                const pt = unproject(clickEvent.clientX, clickEvent.clientY);

                // 如果是添加标记模式
                if (isAddingMarker) {
                    markers.push({
                        lon: pt.lon,
                        lat: pt.lat,
                        style: currentMarkerStyle,
                        color: currentMarkerColor,
                        text: prompt("请输入标记文字:", "标记" + (markers.length + 1))
                    });
                    isAddingMarker = false;
                    canvas.style.cursor = 'crosshair';
                    render();
                    return;
                }

                // 检查是否点击了标记点
                let clickedMarker = -1;
                markers.forEach((marker, index) => {
                    const markerPos = project(marker.lon, marker.lat);
                    const distance = Math.sqrt(Math.pow(clickEvent.clientX - (canvas.width / 2 + view.x + markerPos.x), 2) +
                                             Math.pow(clickEvent.clientY - (canvas.height / 2 + view.y + markerPos.y), 2));
                    if (distance < 35) { // 移动端增加触摸区域
                        clickedMarker = index;
                    }
                });

                if (clickedMarker !== -1) {
                    selectedMarker = clickedMarker;
                    const marker = markers[clickedMarker];
                    infoBox.innerHTML = `
                        <span class="dossier-label">标记点</span><span class="dossier-value">${MARKER_STYLES[marker.style]}</span>
                        <span class="dossier-label">标记文字</span><span class="dossier-value">${marker.text || '无'}</span>
                        <span class="dossier-label">经纬度</span><span class="dossier-value">${marker.lon.toFixed(4)}, ${marker.lat.toFixed(4)}</span>
                        <div style="margin-top:20px;">
                            <button onclick="deleteMarker(${clickedMarker})" style="width:100%;padding:10px;background:#8B0000;color:#FF0000;border:1px solid #FF0000;cursor:pointer;font-family:'Courier New';">[X] 删除此标记</button>
                        </div>
                    `;
                    render();
                    return;
                }

                // 正常点击地块
                const allFeatures = getAllFeatures(MAP_DATA);
                const found = allFeatures.find(f => {
                    if (!f.geometry) return false;
                    const polygons = f.geometry.type === "Polygon" ? [f.geometry.coordinates] : f.geometry.coordinates;
                    return polygons.some(poly => isPointInPoly(pt, poly[0]));
                });

                if (found) {
                    selectedFeature = found;
                    selectedMarker = null;
                    let p = found.properties;
                    let displayName = PROVINCE_NAMES[p.name] || p.name;
                    let displaySide = "";
                    const southVNMCheck = ['Đông Nam Bộ', 'Hồ Chí Minh city', 'Ðong Tháp', 'Can Tho', 'Hau Giang', 'Quàng Nam', 'Đà Nẵng'];

                    if(p.adm0_a3 === 'VNM') {
                        displaySide = (p.side === 'SOUTH' || southVNMCheck.includes(p.name)) ? REGIME_NAMES['VNM_SOUTH'] : REGIME_NAMES['VNM_NORTH'];
                    } else if (p.adm0_a3 === 'MMR') {
                        displaySide = (p.name === 'Shan' || p.name === 'Kachin' || p.side === 'LASHIO') ? REGIME_NAMES['MMR_REBEL'] : REGIME_NAMES['MMR_STABLE'];
                    } else {
                        displaySide = REGIME_NAMES[p.adm0_a3] || "中立/传统辖区";
                    }

                    const statusColor = p.status === 'UNSTABLE' ? '#ff0' : (p.status === 'CAPTURED' ? '#00BFFF' : '#33FF33');

                    infoBox.innerHTML = `
                        <span class="dossier-label">行政扇区</span><span class="dossier-value">${displayName}</span>
                        <span class="dossier-label">地缘主权</span><span class="dossier-value" style="color:#FFFF00">${displaySide}</span>
                        <span class="dossier-label">治安评级</span><span class="dossier-value" style="color:${statusColor}">${p.status || 'STABLE'}</span>
                        <div style="margin-top:20px;">
                            <span class="dossier-label">变更状态</span>
                            <div style="display:flex;gap:5px;margin-top:8px;">
                                <button onclick="changeStatus('${displayName}', 'STABLE')" style="flex:1;padding:8px;background:#006400;color:#00FF00;border:1px solid #00FF00;cursor:pointer;font-family:'Courier New';">稳定</button>
                                <button onclick="changeStatus('${displayName}', 'UNSTABLE')" style="flex:1;padding:8px;background:#8B0000;color:#FF0000;border:1px solid #FF0000;cursor:pointer;font-family:'Courier New';">不稳定</button>
                                <button onclick="changeStatus('${displayName}', 'CAPTURED')" style="flex:1;padding:8px;background:#00008B;color:#00BFFF;border:1px solid #00BFFF;cursor:pointer;font-family:'Courier New';">控制权已夺取</button>
                            </div>
                        </div>
                    `;
                    document.getElementById('log').innerHTML += `<br>> 情报解码: ${displayName}`;
                    render();
                }
            }

            lastTap = currentTime;
        }
    }, { passive: false });

    window.changeStatus = function(featureName, newStatus) {
        if (selectedFeature) {
            selectedFeature.properties.status = newStatus;
            render();
            const statusText = newStatus === 'STABLE' ? '稳定' : (newStatus === 'UNSTABLE' ? '不稳定' : '控制权已夺取');
            document.getElementById('log').innerHTML += `<br>> [更新] ${featureName} 状态变更为: ${statusText}`;

            // 更新信息面板显示
            const p = selectedFeature.properties;
            const statusColor = newStatus === 'STABLE' ? '#33FF33' : (newStatus === 'UNSTABLE' ? '#ff0' : '#00BFFF');
            infoBox.innerHTML = infoBox.innerHTML.replace(
                /<span class="dossier-value" style="color:#[a-fA-F0-9]+">.+<\/span>$/,
                `<span class="dossier-value" style="color:${statusColor}">${statusText}</span>`
            );
        }
    };

    window.deleteMarker = function(index) {
        if (confirm("确定要删除此标记点吗?")) {
            const marker = markers[index];
            markers.splice(index, 1);
            selectedMarker = null;
            render();
            document.getElementById('log').innerHTML += `<br>> 标记点 "${marker.text || '未命名'}" 已删除`;
        }
    };

    let isDragging = false;
    let lastMouse = { x: 0, y: 0 };
    canvas.addEventListener('mousedown', (e) => { isDragging = true; lastMouse = { x: e.clientX, y: e.clientY }; });
    window.addEventListener('mouseup', () => isDragging = false);
    window.addEventListener('mousemove', (e) => {
        if (isDragging) {
            view.x += e.clientX - lastMouse.x;
            view.y += e.clientY - lastMouse.y;
            lastMouse = { x: e.clientX, y: e.clientY };
            render();
        }
        const pt = unproject(e.clientX, e.clientY);
        document.getElementById('coords').innerText = `GRID_REF: [LON:${pt.lon.toFixed(2)} | LAT:${pt.lat.toFixed(2)}]`;
    });
    window.addEventListener('wheel', (e) => {
        e.preventDefault();
        view.zoom *= e.deltaY > 0 ? 0.9 : 1.1;
        render();
    }, { passive: false });

    // 移动端触摸支持
    let isTouchDragging = false;
    let lastTouchDistance = 0;
    let lastTouchCenter = { x: 0, y: 0 };

    // 单指拖动
    canvas.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1) {
            isTouchDragging = true;
            lastTouchCenter = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        } else if (e.touches.length === 2) {
            // 双指缩放
            isTouchDragging = false;
            const dx = e.touches[1].clientX - e.touches[0].clientX;
            const dy = e.touches[1].clientY - e.touches[0].clientY;
            lastTouchDistance = Math.sqrt(dx * dx + dy * dy);
        }
    }, { passive: false });

    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();

        if (e.touches.length === 1 && isTouchDragging) {
            // 单指拖动
            const dx = e.touches[0].clientX - lastTouchCenter.x;
            const dy = e.touches[0].clientY - lastTouchCenter.y;
            view.x += dx;
            view.y += dy;
            lastTouchCenter = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            render();

            const pt = unproject(e.touches[0].clientX, e.touches[0].clientY);
            document.getElementById('coords').innerText = `GRID_REF: [LON:${pt.lon.toFixed(2)} | LAT:${pt.lat.toFixed(2)}]`;
        } else if (e.touches.length === 2) {
            // 双指缩放
            const dx = e.touches[1].clientX - e.touches[0].clientX;
            const dy = e.touches[1].clientY - e.touches[0].clientY;
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (lastTouchDistance > 0) {
                const scale = distance / lastTouchDistance;
                view.zoom *= scale;
                render();
            }

            lastTouchDistance = distance;
        }
    }, { passive: false });

    canvas.addEventListener('touchend', (e) => {
        if (e.touches.length === 0) {
            isTouchDragging = false;
            lastTouchDistance = 0;
        }
    });

    canvas.addEventListener('touchcancel', () => {
        isTouchDragging = false;
        lastTouchDistance = 0;
    });

    window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; render(); };

    // 标记点控制函数
    window.startAddMarker = function() {
        isAddingMarker = true;
        currentMarkerStyle = parseInt(document.getElementById('marker-style').value);
        canvas.style.cursor = 'cell';
        document.getElementById('log').innerHTML += `<br>> 等待点击地图添加标记...`;
    };

    window.clearMarkers = function() {
        if (confirm("确定要清除所有标记点吗?")) {
            markers = [];
            selectedMarker = null;
            render();
            document.getElementById('log').innerHTML += `<br>> 所有标记点已清除`;
        }
    };

    // 初始化颜色面板
    function initColorPalette() {
        const palette = document.getElementById('color-palette');
        MARKER_COLORS.forEach((color, index) => {
            const colorBtn = document.createElement('div');
            colorBtn.style.width = '100%';
            colorBtn.style.height = '25px';
            colorBtn.style.backgroundColor = color;
            colorBtn.style.border = '2px solid #33FF33';
            colorBtn.style.cursor = 'pointer';
            colorBtn.title = color;

            if (index === 0) {
                colorBtn.style.boxShadow = '0 0 5px #FFFFFF';
            }

            colorBtn.onclick = function() {
                currentMarkerColor = color;
                document.querySelectorAll('#color-palette > div').forEach(btn => {
                    btn.style.boxShadow = 'none';
                });
                this.style.boxShadow = '0 0 5px #FFFFFF';
            };

            palette.appendChild(colorBtn);
        });
    }

    // 侧边栏折叠/展开功能
    let sidebarCollapsed = false;
    window.toggleSidebar = function() {
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('toggle-sidebar');

        sidebarCollapsed = !sidebarCollapsed;

        if (sidebarCollapsed) {
            sidebar.classList.add('collapsed');
            toggleBtn.classList.add('show-toggle');
            toggleBtn.innerHTML = '▶';
        } else {
            sidebar.classList.remove('collapsed');
            toggleBtn.classList.remove('show-toggle');
            toggleBtn.innerHTML = '◀';
        }
    };

    // 监听标记样式变化
    document.getElementById('marker-style').addEventListener('change', function() {
        currentMarkerStyle = parseInt(this.value);
    });

    initColorPalette();
    setTimeout(render, 100);
</script>
</body>
</html>